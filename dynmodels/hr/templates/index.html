{% extends "base.html" %}

{% load i18n %}


{% block body %}
    <div class="row">
        <div class="col-md-3">
            <ul class="nav nav-pills nav-stacked">
                <li><a href="/admin/" target="_blank">{% trans "Administration" %}</a></li>
                {% for mdl in models %}
                    <li>
                        <a href="#{{ mdl.lname }}" data-href="{{ mdl.get_list_url }}"
                           data-create-url="{{ mdl.get_create_url }}"
                           data-model="{{ mdl }}">{{ mdl }}</a>
                    </li>
                {% endfor %}
            </ul>
        </div>
        <div class="col-md-9">
            <table class="table table-bordered">
                <tbody></tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block body-tail-js %}
<script>
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    function submit_form_data($form, $td, $input) {
        $.ajax({
            type: 'POST',
            url: $form.attr('action'),
            data: $form.serialize(),
            success: function(data) {
                var response = JSON.parse(data);

                $input.off("focusout");
                var value = $input.val();
                $td.html(value);

                bind_table();
            }
        });
    }

    function bind_form($form, $td, $input) {
        $form.on( "submit", function(event) {
            event.preventDefault();
            submit_form_data($form, $td, $input);
        });
        $form.on("focusout", 'input', function (event) {
            submit_form_data($form, $td, $input);
        });

    }

    function bind_table() {
        var $table = $('table');

        $table.on("click", 'td', function (event) {
            var $td = $(this);
            var value = $td.text();
            var field = $td.attr('data-name');
            var model = $table.attr('data-model');
            var pk = $(this).attr('data-pk');
            var action_url = '/dynmodels/' + model + '/' + pk + '/update';

            $table.off("click");
            $td.html('<form action="' + action_url + '">' +
                     '<input id="id_' + field + '" name="' + field + '" value="' + value + '">' +
                     '</form>');
            var $form = $($td.find('form')[0]);
            var $input = $($form.find('input')[0]);
            bind_form($form, $td, $input);
        });
    }

    $(document).ready(function () {
        var csrftoken = $.cookie('csrftoken');

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        bind_table();

        $('ul.nav li').on("click", 'a', function (event) {
            event.preventDefault();

            $.ajax({
                type: "GET",
                dataType: "json",
                url: $(this).attr('data-href'),
                cache: false
            })
            .done(function( data ) {
                        var head_flag = true;
                        var $table = $('table');
                        var $tbody = $('table > tbody');
                        $tbody.html('');
                        $table.attr('data-model', data.model_name);
                        $.each(data.object_list, function( i, item ) {
                            var $head = $("<tr></tr>");
                            var $row = $("<tr></tr>");
                            $.each(item.fields, function(field, value) {
                                if(head_flag) {$head.append('<th>' + field + '</th>')}
                                $row.append('<td data-pk="' + item.pk + '" data-name="' + field + '" data-type="' + data.types_list[field] + '">' + value + '</td>');
                            });
                            if(head_flag) {
                                $tbody.append($head);
                                head_flag = false;
                            }
                            $tbody.append($row);
                        });
            });
        });
    });
</script>
{% endblock %}